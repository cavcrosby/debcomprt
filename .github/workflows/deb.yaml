name: Create Deb Package

# credits go to:
# https://github.community/t/how-to-run-github-actions-workflow-only-for-new-tags/16075/27
on:
  push:
    branches:
      - "!*"
    tags:
      - "v*"

jobs:
  upload-deb-artifactory:
    runs-on: ubuntu-20.04
    steps:
    - uses: actions/checkout@v2

    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.17

    - name: Set up Go for root
      run: |
        sudo ln --symbolic --force "$(command -v go)" "$(sudo --shell command -v go)"
        sudo go version
        
    - name: Display roots Go env
      run: sudo go env

    - name: Git the tag
      run: echo "GIT_TAG=${GITHUB_REF#refs/tags/}" >> ${GITHUB_ENV}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install --assume-yes \
          build-essential \
          ca-certificates \
          curl \
          debhelper \
          devscripts \
          gnupg \
          lsb-release

    - name: Grab Docker's Official GPG key
      run: |
         curl --fail --show-error --location https://download.docker.com/linux/ubuntu/gpg \
          | sudo gpg --dearmor --output /usr/share/keyrings/docker-archive-keyring.gpg

    - name: Add Docker's stable apt repository
      run: |
         echo \
          "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release --codename --short) stable" \
          | sudo tee /etc/apt/sources.list.d/docker.list

    - name: Install the Docker Engine
      run: |
        sudo apt-get update
        sudo apt-get install --assume-yes \
          docker-ce \
          docker-ce-cli \
          containerd.io

    - name: Verify Docker's Engine was installed
      run: |
        sudo docker run hello-world

    - name: Build deb
      run: |
        make setup
        make IMAGE_RELEASE_BUILD=1 DEBCOMPRT_VERSION=${{ env.GIT_TAG }} deb

    - uses: jfrog/setup-jfrog-cli@v2
      env:
        JF_ARTIFACTORY_1: ${{ secrets.JF_ARTIFACTORY_SECRET_CAVCROSBY }}
      
    - name: Upload deb to artifactory
      run: |
        jfrog rt upload --deb=stable/main/amd64 "$(find ./build/*.deb)" "deb/pool/d/debcomprt/$(find ./build/*.deb -printf '%f')"
